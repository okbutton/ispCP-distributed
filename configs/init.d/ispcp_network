#!/bin/sh

set -e

PATH=/sbin:/bin:/usr/sbin:/usr/bin
DESC="ispCP Network Traffic Logger"
NAME=ispcp_network

IPTABLES=/sbin/iptables
LOGDIR=/var/log/ispcp

START=1

# Read config file if it is present.
if [ -r /etc/default/$NAME ]; then
	. /etc/default/$NAME
fi

if [ $START -eq 0 ]; then
	echo "$DESC: not starting, edit /etc/default/$NAME."
	exit 0
fi

add_rules()
{
	${IPTABLES} -N ISPCP_INPUT 2>> "${LOGDIR}/ispcp_network.err.log"
	${IPTABLES} -N ISPCP_OUTPUT 2>> "${LOGDIR}/ispcp_network.err.log"
	
	# All traffic should jump through ISPCP tables before anything else
	${IPTABLES} -I INPUT -j ISPCP_INPUT 2>> "${LOGDIR}/ispcp_network.err.log"
	${IPTABLES} -I OUTPUT -j ISPCP_OUTPUT 2>> "${LOGDIR}/ispcp_network.err.log"
	
	# web traffic
	
	${IPTABLES} -I ISPCP_INPUT -p tcp --dport 80 2>> "${LOGDIR}/ispcp_network.err.log"
	${IPTABLES} -I ISPCP_OUTPUT -p tcp --sport 80 2>> "${LOGDIR}/ispcp_network.err.log"
	
	# pop3 traffic
	
	${IPTABLES} -I ISPCP_INPUT -p tcp --dport 110 2>> "${LOGDIR}/ispcp_network.err.log"
	${IPTABLES} -I ISPCP_OUTPUT -p tcp --sport 110 2>> "${LOGDIR}/ispcp_network.err.log"
	
	# imap traffic
	
	${IPTABLES} -I ISPCP_INPUT -p tcp --dport 143 2>> "${LOGDIR}/ispcp_network.err.log"
	${IPTABLES} -I ISPCP_OUTPUT -p tcp --sport 143 2>> "${LOGDIR}/ispcp_network.err.log"
	
	# mail traffic
	
	${IPTABLES} -I ISPCP_INPUT  -p tcp --dport 25 2>> "${LOGDIR}/ispcp_network.err.log"
	${IPTABLES} -I ISPCP_OUTPUT -p tcp --sport 25 2>> "${LOGDIR}/ispcp_network.err.log"

	# Explicit return once done
	${IPTABLES} -A ISPCP_INPUT -j RETURN
	${IPTABLES} -A ISPCP_OUTPUT -j RETURN
}

remove_rules()
{
	${IPTABLES} -D INPUT -j ISPCP_INPUT 2>> "${LOGDIR}/ispcp_network.err.log"
	${IPTABLES} -D OUTPUT -j ISPCP_OUTPUT 2>> "${LOGDIR}/ispcp_network.err.log"
	${IPTABLES} -F ISPCP_INPUT 2>> "${LOGDIR}/ispcp_network.err.log"
	${IPTABLES} -F ISPCP_OUTPUT 2>> "${LOGDIR}/ispcp_network.err.log"
	${IPTABLES} -X ISPCP_INPUT 2>> "${LOGDIR}/ispcp_network.err.log"
	${IPTABLES} -X ISPCP_OUTPUT 2>> "${LOGDIR}/ispcp_network.err.log"
}

case "$1" in
  start)
	echo -n "Starting $DESC:"
	add_rules
	echo " $NAME."
	;;
  stop)
	echo -n "Stopping $DESC:"
	remove_rules
	echo " $NAME."
	;;
  restart|force-reload)
	echo -n "Restarting $DESC:"
	remove_rules
	sleep 2
	add_rules
	echo " $NAME."
	;;
  *)
	echo "Usage: /etc/init.d/$NAME {start|stop|restart|force-reload}" >&2
	exit 1
	;;
esac

exit 0


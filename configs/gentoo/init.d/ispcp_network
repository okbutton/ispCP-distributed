#!/sbin/runscript

# ispCP Ï‰ (OMEGA) a Virtual Hosting Control System
# Copyright (c) 2007-2008 by ispCP
# http://www.isp-control.net
#
#
# License:
#    This program is free software; you can redistribute it and/or
#    modify it under the terms of the MPL Mozilla Public License
#    as published by the Free Software Foundation; either version 1.1
#    of the License, or (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    MPL Mozilla Public License for more details.
#
#    You may have received a copy of the MPL Mozilla Public License
#    along with this program.
#
#    An on-line copy of the MPL Mozilla Public License can be found
#    http://www.mozilla.org/MPL/MPL-1.1.html
#
#
# The ispCP Home Page is at:
#
#    http://www.isp-control.net
#

IPTABLES=${IPTABLES:-$(which iptables)}
LOGDIR=${LOGDIR:-"/var/log/ispcp"}
LOGFILE=${LOGFILE:-"${LOGDIR}/${SVCNAME}.log"}

depend() {
	need net
	use iptables
}

add_rules() {
	${IPTABLES} -N ISPCP_INPUT 2>> "$LOGFILE"
	${IPTABLES} -N ISPCP_OUTPUT 2>> "$LOGFILE"

	# All traffic should jump through ISPCP tables before anything else
	${IPTABLES} -I INPUT -j ISPCP_INPUT 2>> "$LOGFILE"
	${IPTABLES} -I OUTPUT -j ISPCP_OUTPUT 2>> "$LOGFILE"

	# web traffic

	${IPTABLES} -I ISPCP_INPUT -p tcp --dport 80 2>> "$LOGFILE"
	${IPTABLES} -I ISPCP_OUTPUT -p tcp --sport 80 2>> "$LOGFILE"

	${IPTABLES} -I ISPCP_INPUT -p tcp --dport 443 2>> "$LOGFILE"
	${IPTABLES} -I ISPCP_OUTPUT -p tcp --sport 443 2>> "$LOGFILE"

	# pop3 traffic

	${IPTABLES} -I ISPCP_INPUT -p tcp --dport 110 2>> "$LOGFILE"
	${IPTABLES} -I ISPCP_OUTPUT -p tcp --sport 110 2>> "$LOGFILE"

	# imap traffic

	${IPTABLES} -I ISPCP_INPUT -p tcp --dport 143 2>> "$LOGFILE"
	${IPTABLES} -I ISPCP_OUTPUT -p tcp --sport 143 2>> "$LOGFILE"

	# mail traffic

	${IPTABLES} -I ISPCP_INPUT  -p tcp --dport 25 2>> "$LOGFILE"
	${IPTABLES} -I ISPCP_OUTPUT -p tcp --sport 25 2>> "$LOGFILE"

	${IPTABLES} -I ISPCP_INPUT  -p tcp --dport 465 2>> "$LOGFILE"
	${IPTABLES} -I ISPCP_OUTPUT -p tcp --sport 465 2>> "$LOGFILE"

	${IPTABLES} -I ISPCP_INPUT  -p tcp --dport 587 2>> "$LOGFILE"
	${IPTABLES} -I ISPCP_OUTPUT -p tcp --sport 587 2>> "$LOGFILE"

	${IPTABLES} -I ISPCP_INPUT  -p tcp --dport 995 2>> "$LOGFILE"
	${IPTABLES} -I ISPCP_OUTPUT -p tcp --sport 995 2>> "$LOGFILE"

	${IPTABLES} -I ISPCP_INPUT  -p tcp --dport 993 2>> "$LOGFILE"
	${IPTABLES} -I ISPCP_OUTPUT -p tcp --sport 993 2>> "$LOGFILE"

	# Explicit return once done
	${IPTABLES} -A ISPCP_INPUT -j RETURN
	${IPTABLES} -A ISPCP_OUTPUT -j RETURN
}

remove_rules() {
	${IPTABLES} -D INPUT -j ISPCP_INPUT 2>> "$LOGFILE"
	${IPTABLES} -D OUTPUT -j ISPCP_OUTPUT 2>> "$LOGFILE"
	${IPTABLES} -F ISPCP_INPUT 2>> "$LOGFILE"
	${IPTABLES} -F ISPCP_OUTPUT 2>> "$LOGFILE"
	${IPTABLES} -X ISPCP_INPUT 2>> "$LOGFILE"
	${IPTABLES} -X ISPCP_OUTPUT 2>> "$LOGFILE"
}

start() {
	ebegin "Starting $SVCNAME"
	add_rules
	eend $?
}

stop() {
	ebegin "Stopping $SVCNAME"
	remove_rules
	eend $?
}


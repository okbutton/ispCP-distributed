HOWTO Update ISPCP 2.4.7 to ISPCP 2.4.7.1 (English)


-------------------
General Information
-------------------

1) Download the newest ISPCP release :

tangra: # wget http://heanet.dl.sourceforge.net/sourceforge/ispcp/ispcp-2.4.7.1.tar.bz2

2) Turn off the ISPCP Daemon:

tangra: # /etc/init.d/ispcp_daemon stop

3) Make a backup of the current ISPCP files of your system:

tangra: # mv /var/www/ispcp/gui /var/www/ispcp/gui_bcp_yyyymmdd
tangra: # mv /var/www/ispcp/engine /var/www/ispcp/engine_bcp_yyyymmdd

4) Unpack the downloaded archive :

tangra: #tar -xjf ispcp-2.4.7.1.tar.bz2


-------------------
ispcp.conf Update
-------------------

1) Change these following lines:

BuildDate = 03.01.2006

Version = 2.4.7.1

ISPCP_LICENSE = ISPCP<sup>&reg;</sup> Pro v2.4.7.1<br>build: 2006-01-03<br>Spartacus

-------------------
Postfix master.cf update
-------------------

1) Edit /etc/postfix/master.cf

and search for the ispcp-arpl line (near the end) replace the flags=D to flags=O
The complete line should look like this:

ispcp-arpl unix  -      n       n       -       -       pipe flags=O user=vmail argv=/var/www/ispcp/engine/messager/ispcp-arpl-msgr


-------------------
Engine Update
-------------------

1) Copy the new engine files

tangra: # cp -a /mydir/engine/ /var/www/ispcp/

2) Copy your crypt key from the old /engine_bcp_yyyymmdd/ispcp-db-keys.pl to /engine/ispcp-db-keys.pl

tangra: # cp /var/www/ispcp/engine_bcp_yyyymmdd/ispcp-db-keys.pl /var/www/ispcp/engine/ispcp-db-keys.pl

3) Copy your crypt key from the old /engine_bcp_yyyymmdd/ispcp-db-keys.pl to /engine/messager/ispcp-db-keys.pl

tangra: # cp /var/www/ispcp/engine_bcp_yyyymmdd/ispcp-db-keys.pl /var/www/ispcp/engine/messager/ispcp-db-keys.pl


Backup Engine Update
-------------------

1) Check and maybe change the crontab line for the backup

tangra: # crontab -e

if line looks like: 

/var/www/ispcp/engine/tools/ispcp-backup-all yes &>/var/log/ispcp/ispcp-backup-all-mngr.log

change it to:

/var/www/ispcp/engine/backup/ispcp-backup-all yes &>/var/log/ispcp/ispcp-backup-all-mngr.log


Mailbox Engine Update
-------------------

1) because of a bug in the catchall adresses we have to rebuild the /etc/postfix/ispcp/aliases

tangra: # mv /etc/ispcp/postfix/working/aliases /etc/ispcp/postfix/working/aliases-SAVE
tangra: # cp /mydir/configs/postfix/working/aliases /etc/ispcp/postfix/working/aliases


Delete unneeded engine file
-------------------
tangra: # rm /var/www/ispcp/engine/setup/ispcp-cfg-subst


Finish Engine Updates
-------------------

1) Set correct engine permissions:

tangra: # /var/www/ispcp/engine/setup/set-engine-permissions.sh


-------------------
GUI Update
-------------------

1) Copy the new GUI files

tangra: # cp -a /mydir/gui/ /var/www/ispcp/

2) Copy your crypt key from the old /gui_bcp_yyyymmdd/include/ispcp-db-keys.php to /gui/include/ispcp-db-keys.php

tangra: # cp /var/www/ispcp/gui_bcp_yyyymmdd/include/ispcp-db-keys.php /var/www/ispcp/gui/include/ispcp-db-keys.php

3) Set correct gui permissions:

tangra: # /var/www/ispcp/engine/setup/set-gui-permissions.sh

-------------------
Database Update
-------------------

1) Updated languages completely by importing the languages.sql For example with phpmyadmin or over commandline. 
All languages are changed. Please use languages.sql because it's the only way to update lang_english which is
not update-able by language file. languages.sql is located in: 

configs/database/languages.sql


2) Delete all wrong added and not shown catchalls for alias domains

DELETE FROM `ispcp`.`mail_users` WHERE `sub_id`='0' AND `mail_type` = 'alias_catchall';


3) Change status for all mail-addresses:

UPDATE `ispcp`.`mail_users` SET `status` = 'change' WHERE `status` = 'ok';

-------------------
Finish update
-------------------

1) Now you should execute the ISPCP engine manually, because users/customers may have made system changes during your update operation
   This could take a moment!

tangra: # /var/www/ispcp/engine/ispcp-rqst-mngr

2) Now you can start the ISPCP daemon

tangra: # /etc/init.d/ispcp_daemon start


ISPCP is successfully updated !

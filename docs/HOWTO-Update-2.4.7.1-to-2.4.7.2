HOWTO Update VHCS 2.4.7.1 to VHCS 2.4.7.2 (English)


-------------------
General Information
-------------------

1) Download the newest VHCS2 release :

tangra: # wget http://heanet.dl.sourceforge.net/sourceforge/vhcs/vhcs2-2.4.7.2.tar.bz2

2) Turn off the VHCS Daemon:

tangra: # /etc/init.d/vhcs2_daemon stop

3) Make a backup of the current VHCS files of your system:

tangra: # mv /var/www/vhcs2/gui /var/www/vhcs2/gui_bcp_yyyymmdd
tangra: # mv /var/www/vhcs2/engine /var/www/vhcs2/engine_bcp_yyyymmdd

4) Unpack the downloaded archive :

tangra: #tar -xjf vhcs2-2.4.7.2.tar.bz2


-------------------
vhcs2.conf Update
-------------------

1) Change these following lines:

BuildDate = XX.XX.2006

Version = 2.4.7.2

VHCS_LICENSE = VHCS<sup>&reg;</sup> Pro v2.4.7.2<br>build: 2006-XX-XX<br>Spartacus

2) Some language database tables will be changed with the next steps so an update here is needed if you

if your USER_INITIAL_LANG looks like:
	USER_INITIAL_LANG = lang_Deutsch
you must turn it to :
	USER_INITIAL_LANG = lang_German

if your USER_INITIAL_LANG looks like:
	USER_INITIAL_LANG = lang_Portugues_Brasil
you must turn it to :
	USER_INITIAL_LANG = lang_PortuguesBrazil


-------------------
Postfix main.cf update
-------------------

1) Edit /etc/postfix/main.cf

and search for the line: "local_recipient_maps = unix:passwd.byname $alias_database"
and insert directly under this line:

#
# VHCS Autoresponder paramters;
#

-------------------
Postfix master.cf update
-------------------

If you want/need it you can take a look at the preconfiguration for amavis in the
master.cf in /mydir/configs/postfix/master.cf You'll find the entrys at the end of the file


-------------------
Engine Update
-------------------

1) Copy the new engine files

tangra: # cp -a /mydir/engine/ /var/www/vhcs2/

2) Copy your crypt key from the old /engine_bcp_yyyymmdd/vhcs2-db-keys.pl to /engine/vhcs2-db-keys.pl

tangra: # cp /var/www/vhcs2/engine_bcp_yyyymmdd/vhcs2-db-keys.pl /var/www/vhcs2/engine/vhcs2-db-keys.pl

3) Copy your crypt key from the old /engine_bcp_yyyymmdd/vhcs2-db-keys.pl to /engine/messager/vhcs2-db-keys.pl

tangra: # cp /var/www/vhcs2/engine_bcp_yyyymmdd/vhcs2-db-keys.pl /var/www/vhcs2/engine/messager/vhcs2-db-keys.pl


The new autoresponder logs to his own directory (needs extra permissions)

	mkdir -p /var/log/vhcs2/vhcs2-arpl-msgr
	chown vmail:mail /var/log/vhcs2/vhcs2-arpl-msgr

Extra notes for chown command:
vmail is value of MTA_MAILBOX_UID_NAME from vhcs2.conf
mail is value of MTA_MAILBOX_GID_NAME from vhcs2.conf


Backup Engine Update
-------------------

1) Delete old no longer needed backup manager if it exists

tangra: # rm /var/www/vhcs2/engine/tools/vhcs2-backup-all

2) Check and maybe change the crontab line for the backup

tangra: # crontab -e

if line looks like:

/var/www/vhcs2/engine/tools/vhcs2-backup-all yes &>/var/log/vhcs2/vhcs2-backup-all-mngr.log

change it to:

/var/www/vhcs2/engine/backup/vhcs2-backup-all yes &>/var/log/vhcs2/vhcs2-backup-all-mngr.log


Engine Templates Update
-------------------

1) Update apache templates part for domains (vhosts php settings):

tangra: # cp /mydir/configs/apache/parts/als_php2_entry.tpl /etc/vhcs2/apache/parts/
tangra: # cp /mydir/configs/apache/parts/dmn_php2_entry.tpl /etc/vhcs2/apache/parts/
tangra: # cp /mydir/configs/apache/parts/sub_php2_entry.tpl /etc/vhcs2/apache/parts/

If you changed one of the following templates are updated in this release and need to be
updated with your own changes:

	dmn_entry.tpl, sub_entry.tpl, als_entry.tpl,
	dmn_php2_entry.tpl, sub_php2_entry.tpl, als_php2_entry.tpl

If you installed global applications like horde or others and defined entrys like:

Alias /horde /var/www/horde
Alias /webmail /var/www/horde
<Directory /var/www/horde>
    AllowOverride none
    Options MultiViews IncludesNoExec FollowSymLinks
    php_admin_value open_basedir "/var/www/horde/:/usr/share/php/:/tmp/:/var/tmp/"
</Directory>

	then you need to add a global session.save_path and upload_tmp_dir to these entrys, like that:

Alias /horde /var/www/horde
Alias /webmail /var/www/horde
<Directory /var/www/horde>
    AllowOverride none
    Options MultiViews IncludesNoExec FollowSymLinks
    php_admin_value open_basedir "/var/www/horde/:/usr/share/php/:/tmp/:/var/tmp/"
    php_admin_value session.save_path "/tmp/"
    php_admin_value upload_tmp_dir "/tmp/"
</Directory>



Finish Engine Updates
-------------------

1) Set correct engine permissions:

tangra: # /var/www/vhcs2/engine/setup/set-engine-permissions.sh


-------------------
GUI Update
-------------------

1) Copy the new GUI files

tangra: # cp -a /mydir/gui/ /var/www/vhcs2/

2) Copy your crypt key from the old /gui_bcp_yyyymmdd/include/vhcs2-db-keys.php to /gui/include/vhcs2-db-keys.php

tangra: # cp /var/www/vhcs2/gui_bcp_yyyymmdd/include/vhcs2-db-keys.php /var/www/vhcs2/gui/include/vhcs2-db-keys.php

3) If you want to see date and time in your default language on the vhcs login page you need to configure system locales
   on debian run: dpkg-reconfigure locales (or if not installed: apt-get install locales) then select the locales you want to use.
   After generating the locales (takes some time) restart your Apache webserver (/etc/init.d/apache2 restart).

4) Set correct gui permissions:

tangra: # /var/www/vhcs2/engine/setup/set-gui-permissions.sh

-------------------
Database Update
-------------------

1) Database structure must be updated:

ALTER TABLE `vhcs2`.`login` ADD `ipaddr` varchar(15) NULL AFTER `session_id`;
ALTER TABLE `vhcs2`.`login` ADD `user_name` varchar(255) NULL AFTER `ipaddr`;
ALTER TABLE `vhcs2`.`login` ADD `login_count` tinyint(1) NULL AFTER `lastaccess`;

CREATE TABLE `vhcs2`.`config` (`name` varchar(255) NOT NULL default '',`value` varchar(255) NOT NULL default '',PRIMARY KEY  (`name`));
INSERT INTO `config` (`name`,`value`) VALUES ('PORT_FTP','21;tcp;FTP;1;0'),('PORT_SSH','22;tcp;SSH;1;0'),('PORT_TELNET','23;tcp;TELNET;1;0'),('PORT_SMTP','25;tcp;SMPT;1;0'),('PORT_DNS','53;tcp;DNS;1;0'),('PORT_HTTP','80;tcp;HTTP;1;0'),('PORT_HTTPS','443;tcp;HTTPS;1;0'),('PORT_POP3','110;tcp;POP3;1;0'),('PORT_POP3-SSL','995;tcp;POP3-SSL;1;0'),('PORT_IMAP','143;tcp;IMAP;1;0'),('PORT_IMAP-SSL','993;tcp;IMAP-SSL;1;0');

ALTER TABLE `vhcs2`.`admin` ADD `uniqkey_time` TIMESTAMP NULL AFTER `uniqkey`;
ALTER TABLE `vhcs2`.`admin` ADD UNIQUE ( `admin_name` );
ALTER TABLE `vhcs2`.`domain` ADD INDEX i_domain_domain_admin_id ( `domain_admin_id` );
ALTER TABLE `vhcs2`.`domain` ADD UNIQUE ( `domain_name` );
ALTER TABLE `vhcs2`.`domain_traffic` ADD INDEX i_domain_traffic_domain_id ( `domain_id` );

ALTER TABLE `vhcs2`.`htaccess_users` ADD `status` varchar(255) default NULL;
ALTER TABLE `vhcs2`.`htaccess_groups` ADD `status` varchar(255) default NULL;
ALTER TABLE `vhcs2`.`htaccess` CHANGE `status` `status` VARCHAR( 255 ) default NULL;

2) Updated languages completely by importing the languages.sql For example with phpmyadmin or over commandline.
All languages are changed. Please use languages.sql because it's the only way to update lang_english which is
not update-able by language file. languages.sql is located in:

configs/database/languages.sql

2.1) Drop the not working language tables, the new one will be imported with the next step.

DROP TABLE IF EXISTS `vhcs2`.`lang_Deutsch`;
DROP TABLE IF EXISTS `vhcs2`.`lang_Portugues_Brasil`;

2.2) Update the user properties

UPDATE `vhcs2`.`user_gui_props` SET `lang` = 'lang_German' WHERE `lang` = 'lang_Deutsch';
UPDATE `vhcs2`.`user_gui_props` SET `lang` = 'lang_PortuguesBrazil' WHERE `lang` = 'lang_Portugues_Brasil';

2.3) The update of the user-porp. recommand a session clean up

DELETE FROM `vhcs2`.`login`;

3) Change status for rebuild apache conf for all domains:

UPDATE `vhcs2`.`subdomain` SET `subdomain_status` = 'change' WHERE `subdomain_status` = 'ok';
UPDATE `vhcs2`.`domain` SET `domain_status` = 'change' WHERE `domain_status` = 'ok';
UPDATE `vhcs2`.`domain_aliasses` SET `alias_status` = 'change' WHERE `alias_status` = 'ok';


-------------------
Daemon & init.d Update
-------------------

1) Make the new daemon:

tangra: # cd /mydir/tools/daemon
tangra: # make
tangra: # cp ./vhcs2_daemon /var/www/vhcs2/daemon/vhcs2_daemon


-------------------
Finish update
-------------------

1) Now you should execute the VHCS engine manually, because users/customers may have made system changes during your update operation
   This could take a moment!

tangra: # /var/www/vhcs2/engine/vhcs2-rqst-mngr

2) Now you can start the VHCS daemon

tangra: # /etc/init.d/vhcs2_daemon start


VHCS is successfully updated !
